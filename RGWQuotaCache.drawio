<mxfile host="app.diagrams.net" modified="2024-08-16T02:48:04.378Z" agent="Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/127.0.0.0 Safari/537.36" etag="aF6opa2_HXsJ2irTg57p" version="24.7.3" type="github">
  <diagram name="第 1 页" id="NyUh1yyV36GHHRMd1uLf">
    <mxGraphModel dx="3695" dy="2809" grid="1" gridSize="10" guides="1" tooltips="1" connect="1" arrows="1" fold="1" page="1" pageScale="1" pageWidth="827" pageHeight="1169" math="0" shadow="0">
      <root>
        <mxCell id="0" />
        <mxCell id="1" parent="0" />
        <mxCell id="rM31WVM_aIMixApUrWMA-1" value="&lt;p style=&quot;margin: 0px; font-variant-numeric: normal; font-variant-east-asian: normal; font-variant-alternates: normal; font-size-adjust: none; font-kerning: auto; font-optical-sizing: auto; font-feature-settings: normal; font-variation-settings: normal; font-variant-position: normal; font-stretch: normal; font-size: 13px; line-height: normal; font-family: &amp;quot;Helvetica Neue&amp;quot;; text-align: start;&quot; class=&quot;p1&quot;&gt;RGWQuotaCache &amp;lt;&lt;span style=&quot;background-color: initial;&quot;&gt;T&lt;/span&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&amp;gt;&lt;/span&gt;&lt;/p&gt;" style="swimlane;fontStyle=1;align=center;verticalAlign=top;childLayout=stackLayout;horizontal=1;startSize=26;horizontalStack=0;resizeParent=1;resizeParentMax=0;resizeLast=0;collapsible=1;marginBottom=0;whiteSpace=wrap;html=1;" vertex="1" parent="1">
          <mxGeometry x="40" y="130" width="840" height="280" as="geometry" />
        </mxCell>
        <mxCell id="rM31WVM_aIMixApUrWMA-2" value="+ stats_map:&amp;nbsp;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;lru_map&amp;lt;T, RGWQuotaCacheStats&amp;gt;" style="text;strokeColor=none;fillColor=none;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;whiteSpace=wrap;html=1;" vertex="1" parent="rM31WVM_aIMixApUrWMA-1">
          <mxGeometry y="26" width="840" height="26" as="geometry" />
        </mxCell>
        <mxCell id="rM31WVM_aIMixApUrWMA-3" value="" style="line;strokeWidth=1;fillColor=none;align=left;verticalAlign=middle;spacingTop=-1;spacingLeft=3;spacingRight=3;rotatable=0;labelPosition=right;points=[];portConstraint=eastwest;strokeColor=inherit;" vertex="1" parent="rM31WVM_aIMixApUrWMA-1">
          <mxGeometry y="52" width="840" height="8" as="geometry" />
        </mxCell>
        <mxCell id="rM31WVM_aIMixApUrWMA-4" value="- fetch_stats_from_storage(const rgw_user&amp;amp; user, const rgw_bucket&amp;amp; bucket, RGWStorageStats&amp;amp; stats): virtual int = 0&lt;div&gt;-&amp;nbsp;map_find(const rgw_user&amp;amp; user, const rgw_bucket&amp;amp; bucket, RGWQuotaCacheStats&amp;amp; qs):&amp;nbsp;&lt;span style=&quot;background-color: initial;&quot;&gt;virtual int = 0&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;-&amp;nbsp;&lt;/span&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;data_modified(const rgw_user&amp;amp; user, rgw_bucket&amp;amp; bucket):&amp;nbsp;&lt;/span&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;virtual void {}&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;+&amp;nbsp;&lt;/span&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;get_stats(const rgw_user&amp;amp; user, const rgw_bucket&amp;amp; bucket, RGWStorageStats&amp;amp; stats, RGWQuotaInfo&amp;amp; quota):&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;int&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;+&amp;nbsp;&lt;/span&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;adjust_stats(const rgw_user&amp;amp; user, rgw_bucket&amp;amp; bucket, int objs_delta, uint64_t added_bytes, uint64_t removed_bytes): void&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;+&amp;nbsp;&lt;/span&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;can_use_cached_stats(RGWQuotaInfo&amp;amp; quota, RGWStorageStats&amp;amp; stats): virtual bool&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;+&amp;nbsp;&lt;/span&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;set_stats(const rgw_user&amp;amp; user, const rgw_bucket&amp;amp; bucket, RGWQuotaCacheStats&amp;amp; qs, RGWStorageStats&amp;amp; stats): void&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;+&amp;nbsp;&lt;/span&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;async_refresh(const rgw_user&amp;amp; user, const rgw_bucket&amp;amp; bucket, RGWQuotaCacheStats&amp;amp; qs): int&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;// get&amp;nbsp;&lt;/span&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;AsyncRefreshHandler，触发&amp;nbsp;&lt;/span&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;init_fetch&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;+&amp;nbsp;&lt;/span&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;async_refresh_response(const rgw_user&amp;amp; user, rgw_bucket&amp;amp; bucket, RGWStorageStats&amp;amp; stats): void&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;// 调用&amp;nbsp;&lt;/span&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;set_stats(user, bucket, qs, stats);&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;+&amp;nbsp;&lt;/span&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;allocate_refresh_handler(const rgw_user&amp;amp; user, const rgw_bucket&amp;amp; bucket):&amp;nbsp;&lt;/span&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;virtual AsyncRefreshHandler * = 0&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;/div&gt;" style="text;strokeColor=none;fillColor=none;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;whiteSpace=wrap;html=1;" vertex="1" parent="rM31WVM_aIMixApUrWMA-1">
          <mxGeometry y="60" width="840" height="220" as="geometry" />
        </mxCell>
        <mxCell id="rM31WVM_aIMixApUrWMA-5" value="RGWStorageStats" style="swimlane;fontStyle=1;align=center;verticalAlign=top;childLayout=stackLayout;horizontal=1;startSize=26;horizontalStack=0;resizeParent=1;resizeParentMax=0;resizeLast=0;collapsible=1;marginBottom=0;whiteSpace=wrap;html=1;" vertex="1" parent="1">
          <mxGeometry x="140" y="-66" width="170" height="100" as="geometry" />
        </mxCell>
        <mxCell id="rM31WVM_aIMixApUrWMA-6" value="+ size: &lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;uint64_t&lt;div&gt;+&amp;nbsp;size_rounded:&amp;nbsp;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;uint64_t&lt;/span&gt;&lt;/div&gt;&lt;div&gt;+&amp;nbsp;size_utilized:&amp;nbsp;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;uint64_t&lt;/span&gt;&lt;/div&gt;&lt;div&gt;+&amp;nbsp;num_objects:&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;uint64_t&lt;/span&gt;&lt;/div&gt;" style="text;strokeColor=none;fillColor=none;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;whiteSpace=wrap;html=1;" vertex="1" parent="rM31WVM_aIMixApUrWMA-5">
          <mxGeometry y="26" width="170" height="74" as="geometry" />
        </mxCell>
        <mxCell id="rM31WVM_aIMixApUrWMA-9" value="RGWQuotaCacheStats" style="swimlane;fontStyle=1;align=center;verticalAlign=top;childLayout=stackLayout;horizontal=1;startSize=26;horizontalStack=0;resizeParent=1;resizeParentMax=0;resizeLast=0;collapsible=1;marginBottom=0;whiteSpace=wrap;html=1;" vertex="1" parent="1">
          <mxGeometry x="390" y="-66" width="290" height="100" as="geometry" />
        </mxCell>
        <mxCell id="rM31WVM_aIMixApUrWMA-10" value="+ stats:&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;/span&gt;RGWStorageStats&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;+&amp;nbsp;expiration:&amp;nbsp;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;utime_t&lt;/div&gt;&lt;div&gt;+&amp;nbsp;async_refresh_time:&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;utime_t&lt;/span&gt;&lt;/div&gt;" style="text;strokeColor=none;fillColor=none;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;whiteSpace=wrap;html=1;" vertex="1" parent="rM31WVM_aIMixApUrWMA-9">
          <mxGeometry y="26" width="290" height="74" as="geometry" />
        </mxCell>
        <mxCell id="rM31WVM_aIMixApUrWMA-13" value="AsyncRefreshHandler" style="swimlane;fontStyle=1;align=center;verticalAlign=top;childLayout=stackLayout;horizontal=1;startSize=26;horizontalStack=0;resizeParent=1;resizeParentMax=0;resizeLast=0;collapsible=1;marginBottom=0;whiteSpace=wrap;html=1;" vertex="1" parent="1">
          <mxGeometry x="-470" y="150" width="240" height="100" as="geometry" />
        </mxCell>
        <mxCell id="rM31WVM_aIMixApUrWMA-14" value="+ cache:&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;RGWQuotaCache&amp;lt;T&amp;gt; *" style="text;strokeColor=none;fillColor=none;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;whiteSpace=wrap;html=1;" vertex="1" parent="rM31WVM_aIMixApUrWMA-13">
          <mxGeometry y="26" width="240" height="26" as="geometry" />
        </mxCell>
        <mxCell id="rM31WVM_aIMixApUrWMA-15" value="" style="line;strokeWidth=1;fillColor=none;align=left;verticalAlign=middle;spacingTop=-1;spacingLeft=3;spacingRight=3;rotatable=0;labelPosition=right;points=[];portConstraint=eastwest;strokeColor=inherit;" vertex="1" parent="rM31WVM_aIMixApUrWMA-13">
          <mxGeometry y="52" width="240" height="8" as="geometry" />
        </mxCell>
        <mxCell id="rM31WVM_aIMixApUrWMA-16" value="+ init_fetch(): &lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;virtual int = 0&lt;div&gt;+&amp;nbsp;drop_reference(): virtual void = 0&lt;/div&gt;" style="text;strokeColor=none;fillColor=none;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;whiteSpace=wrap;html=1;" vertex="1" parent="rM31WVM_aIMixApUrWMA-13">
          <mxGeometry y="60" width="240" height="40" as="geometry" />
        </mxCell>
        <mxCell id="rM31WVM_aIMixApUrWMA-17" value="&lt;p style=&quot;line-height: 60%;&quot;&gt;&lt;/p&gt;&lt;h1 style=&quot;margin-top: 0px; line-height: 40%;&quot;&gt;RGWQuotaCache&amp;lt;T&amp;gt;::get_stats&lt;/h1&gt;&lt;p style=&quot;margin-top: 0px; margin-bottom: 0px; line-height: 40%;&quot;&gt;RGWQuotaCacheStats qs;&lt;/p&gt;&lt;p style=&quot;line-height: 40%;&quot;&gt;utime_t now = ceph_clock_now();&lt;/p&gt;&lt;p style=&quot;line-height: 40%;&quot;&gt;&amp;nbsp; if (map_find(user, bucket, qs)) {&lt;/p&gt;&lt;p style=&quot;line-height: 40%;&quot;&gt;&amp;nbsp; &amp;nbsp; if (qs.async_refresh_time.sec() &amp;gt; 0 &amp;amp;&amp;amp; now &amp;gt;= qs.async_refresh_time) {&lt;/p&gt;&lt;p style=&quot;line-height: 40%;&quot;&gt;&lt;span style=&quot;background-color: initial; white-space: pre;&quot;&gt;&amp;nbsp;     &lt;/span&gt;&lt;span style=&quot;color: rgb(255, 0, 0); background-color: initial;&quot;&gt;// 异步更新缓存&lt;/span&gt;&lt;/p&gt;&lt;p style=&quot;line-height: 40%;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; int r = async_refresh(user, bucket, qs);&lt;/p&gt;&lt;p style=&quot;line-height: 40%;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; if (r &amp;lt; 0) {&lt;/p&gt;&lt;p style=&quot;line-height: 40%;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; ldout(store-&amp;gt;ctx(), 0) &amp;lt;&amp;lt; &quot;ERROR: quota async refresh returned ret=&quot; &amp;lt;&amp;lt; r &amp;lt;&amp;lt; dendl;&lt;/p&gt;&lt;p style=&quot;line-height: 40%;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; /* continue processing, might be a transient error, async refresh is just optimization */&lt;/p&gt;&lt;p style=&quot;line-height: 40%;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/p&gt;&lt;p style=&quot;line-height: 40%;&quot;&gt;&amp;nbsp; &amp;nbsp; }&lt;/p&gt;&lt;p style=&quot;line-height: 40%;&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;line-height: 40%;&quot;&gt;&amp;nbsp; &amp;nbsp;&amp;nbsp;&lt;span style=&quot;color: rgb(255, 0, 0); background-color: initial;&quot;&gt;// 使用缓存&lt;/span&gt;&lt;/p&gt;&lt;p style=&quot;line-height: 40%;&quot;&gt;&amp;nbsp; &amp;nbsp; if (can_use_cached_stats(quota, qs.stats) &amp;amp;&amp;amp; qs.expiration &amp;gt;&lt;/p&gt;&lt;p style=&quot;line-height: 40%;&quot;&gt;&lt;span style=&quot;white-space: normal;&quot;&gt;&lt;span style=&quot;white-space:pre&quot;&gt;&#x9;&lt;/span&gt;&amp;nbsp; ceph_clock_now()) {&lt;/span&gt;&lt;/p&gt;&lt;p style=&quot;line-height: 40%;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; stats = qs.stats;&lt;/p&gt;&lt;p style=&quot;line-height: 40%;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; return 0;&lt;/p&gt;&lt;p style=&quot;line-height: 40%;&quot;&gt;&amp;nbsp; &amp;nbsp; }&lt;/p&gt;&lt;p style=&quot;line-height: 40%;&quot;&gt;&amp;nbsp; }&lt;/p&gt;&lt;p style=&quot;line-height: 40%;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;line-height: 40%;&quot;&gt;&lt;font color=&quot;#ff0000&quot;&gt;&amp;nbsp; // 同步更新缓存&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;line-height: 40%;&quot;&gt;&amp;nbsp; int ret = fetch_stats_from_storage(user, bucket, stats);&lt;/p&gt;&lt;p style=&quot;line-height: 40%;&quot;&gt;&amp;nbsp; if (ret &amp;lt; 0 &amp;amp;&amp;amp; ret != -ENOENT)&lt;/p&gt;&lt;p style=&quot;line-height: 40%;&quot;&gt;&amp;nbsp; &amp;nbsp; return ret;&lt;/p&gt;&lt;p style=&quot;line-height: 40%;&quot;&gt;&amp;nbsp;&amp;nbsp;&lt;/p&gt;&lt;p style=&quot;line-height: 40%;&quot;&gt;&amp;nbsp; set_stats(user, bucket, qs, stats);&lt;/p&gt;&lt;p&gt;&lt;/p&gt;" style="text;html=1;whiteSpace=wrap;overflow=hidden;rounded=0;fillColor=#f5f5f5;fontColor=#333333;strokeColor=#666666;" vertex="1" parent="1">
          <mxGeometry x="990" y="50" width="500" height="490" as="geometry" />
        </mxCell>
        <mxCell id="rM31WVM_aIMixApUrWMA-18" value="&lt;p style=&quot;line-height: 60%;&quot;&gt;&lt;/p&gt;&lt;h1 style=&quot;margin-top: 0px; line-height: 9.6px;&quot;&gt;RGWQuotaCache&amp;lt;T&amp;gt;::async_refresh&lt;/h1&gt;&lt;h1 style=&quot;margin-top: 0px; line-height: 50%;&quot;&gt;&lt;p style=&quot;font-size: 12px; font-weight: 400; margin-top: 0px; margin-bottom: 0px; line-height: 4.8px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin-top: 0px; margin-bottom: 0px; line-height: 50%;&quot;&gt;&lt;span style=&quot;font-size: 12px; font-weight: 400;&quot;&gt;AsyncRefreshHandler *handler = allocate_refresh_handler(user, bucket);&lt;/span&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin-top: 0px; margin-bottom: 0px; line-height: 50%;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin-top: 0px; margin-bottom: 0px; line-height: 50%;&quot;&gt;&lt;span style=&quot;font-size: 12px; font-weight: 400;&quot;&gt;int ret = handler-&amp;gt;init_fetch();&lt;/span&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin-top: 0px; margin-bottom: 0px; line-height: 50%;&quot;&gt;&lt;span style=&quot;font-size: 12px; font-weight: 400;&quot;&gt;if (ret &amp;lt; 0) {&lt;/span&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin-top: 0px; margin-bottom: 0px; line-height: 50%;&quot;&gt;&lt;span style=&quot;font-size: 12px; font-weight: 400;&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;handler-&amp;gt;drop_reference();&lt;/span&gt;&lt;/p&gt;&lt;p style=&quot;margin-top: 0px; margin-bottom: 0px; line-height: 50%;&quot;&gt;&lt;span style=&quot;font-size: 12px; font-weight: 400;&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;return ret;&lt;/span&gt;&lt;/p&gt;&lt;p style=&quot;margin-top: 0px; margin-bottom: 0px; line-height: 50%;&quot;&gt;&lt;/p&gt;&lt;p style=&quot;margin-top: 0px; margin-bottom: 0px; line-height: 50%;&quot;&gt;&lt;span style=&quot;font-size: 12px; font-weight: 400;&quot;&gt;}&lt;/span&gt;&lt;/p&gt;&lt;p style=&quot;margin-top: 0px; margin-bottom: 0px; line-height: 50%;&quot;&gt;&lt;span style=&quot;font-size: 12px; font-weight: 400;&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;/p&gt;&lt;p style=&quot;margin-top: 0px; margin-bottom: 0px; line-height: 50%;&quot;&gt;&lt;span style=&quot;font-size: 12px; font-weight: 400;&quot;&gt;return 0&lt;/span&gt;&lt;/p&gt;&lt;/h1&gt;&lt;p&gt;&lt;/p&gt;" style="text;html=1;whiteSpace=wrap;overflow=hidden;rounded=0;fillColor=#f5f5f5;fontColor=#333333;strokeColor=#666666;" vertex="1" parent="1">
          <mxGeometry x="990" y="570" width="500" height="200" as="geometry" />
        </mxCell>
        <mxCell id="rM31WVM_aIMixApUrWMA-19" value="BucketAsyncRefreshHandler" style="swimlane;fontStyle=1;align=center;verticalAlign=top;childLayout=stackLayout;horizontal=1;startSize=26;horizontalStack=0;resizeParent=1;resizeParentMax=0;resizeLast=0;collapsible=1;marginBottom=0;whiteSpace=wrap;html=1;" vertex="1" parent="1">
          <mxGeometry x="-780" y="454" width="250" height="158" as="geometry" />
        </mxCell>
        <mxCell id="rM31WVM_aIMixApUrWMA-20" value="+ user:&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;rgw_user&lt;div&gt;+ bucket:&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;rgw_bucket&lt;/span&gt;&lt;/div&gt;" style="text;strokeColor=none;fillColor=none;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;whiteSpace=wrap;html=1;" vertex="1" parent="rM31WVM_aIMixApUrWMA-19">
          <mxGeometry y="26" width="250" height="44" as="geometry" />
        </mxCell>
        <mxCell id="rM31WVM_aIMixApUrWMA-21" value="" style="line;strokeWidth=1;fillColor=none;align=left;verticalAlign=middle;spacingTop=-1;spacingLeft=3;spacingRight=3;rotatable=0;labelPosition=right;points=[];portConstraint=eastwest;strokeColor=inherit;" vertex="1" parent="rM31WVM_aIMixApUrWMA-19">
          <mxGeometry y="70" width="250" height="8" as="geometry" />
        </mxCell>
        <mxCell id="rM31WVM_aIMixApUrWMA-22" value="+ init_fetch(): int&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;// 异步 get bucket 的 stats 信息后，调用&amp;nbsp;&amp;nbsp;cache-&amp;gt;async_refresh_response(user, bucket, bs);&amp;nbsp;" style="text;strokeColor=none;fillColor=none;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;whiteSpace=wrap;html=1;" vertex="1" parent="rM31WVM_aIMixApUrWMA-19">
          <mxGeometry y="78" width="250" height="80" as="geometry" />
        </mxCell>
        <mxCell id="rM31WVM_aIMixApUrWMA-23" value="UserAsyncRefreshHandler" style="swimlane;fontStyle=1;align=center;verticalAlign=top;childLayout=stackLayout;horizontal=1;startSize=26;horizontalStack=0;resizeParent=1;resizeParentMax=0;resizeLast=0;collapsible=1;marginBottom=0;whiteSpace=wrap;html=1;" vertex="1" parent="1">
          <mxGeometry x="-420" y="460" width="370" height="140" as="geometry" />
        </mxCell>
        <mxCell id="rM31WVM_aIMixApUrWMA-24" value="+ user:&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;rgw_user&lt;div&gt;+ bucket:&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;rgw_bucket&lt;/span&gt;&lt;/div&gt;" style="text;strokeColor=none;fillColor=none;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;whiteSpace=wrap;html=1;" vertex="1" parent="rM31WVM_aIMixApUrWMA-23">
          <mxGeometry y="26" width="370" height="44" as="geometry" />
        </mxCell>
        <mxCell id="rM31WVM_aIMixApUrWMA-25" value="" style="line;strokeWidth=1;fillColor=none;align=left;verticalAlign=middle;spacingTop=-1;spacingLeft=3;spacingRight=3;rotatable=0;labelPosition=right;points=[];portConstraint=eastwest;strokeColor=inherit;" vertex="1" parent="rM31WVM_aIMixApUrWMA-23">
          <mxGeometry y="70" width="370" height="8" as="geometry" />
        </mxCell>
        <mxCell id="rM31WVM_aIMixApUrWMA-26" value="+ init_fetch(): int&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;// 异步 get user 的 stats 信息后，调用&amp;nbsp;&amp;nbsp;cache-&amp;gt;async_refresh_response(user, bucket, bs);&amp;nbsp;" style="text;strokeColor=none;fillColor=none;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;whiteSpace=wrap;html=1;" vertex="1" parent="rM31WVM_aIMixApUrWMA-23">
          <mxGeometry y="78" width="370" height="62" as="geometry" />
        </mxCell>
        <mxCell id="rM31WVM_aIMixApUrWMA-28" value="RGWBucketStatsCache" style="swimlane;fontStyle=1;align=center;verticalAlign=top;childLayout=stackLayout;horizontal=1;startSize=26;horizontalStack=0;resizeParent=1;resizeParentMax=0;resizeLast=0;collapsible=1;marginBottom=0;whiteSpace=wrap;html=1;" vertex="1" parent="1">
          <mxGeometry x="-380" y="710" width="470" height="96" as="geometry" />
        </mxCell>
        <mxCell id="rM31WVM_aIMixApUrWMA-31" value="+ fetch_stats_from_storage(type): int override&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;// 同步的 get bucket stats&lt;div&gt;+&amp;nbsp;allocate_refresh_handler:&amp;nbsp;AsyncRefreshHandler *&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;//&amp;nbsp;new BucketAsyncRefreshHandler(store, this, user, bucket);&lt;/div&gt;" style="text;strokeColor=none;fillColor=none;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;whiteSpace=wrap;html=1;" vertex="1" parent="rM31WVM_aIMixApUrWMA-28">
          <mxGeometry y="26" width="470" height="70" as="geometry" />
        </mxCell>
        <mxCell id="rM31WVM_aIMixApUrWMA-32" value="RGWUserStatsCache" style="swimlane;fontStyle=1;align=center;verticalAlign=top;childLayout=stackLayout;horizontal=1;startSize=26;horizontalStack=0;resizeParent=1;resizeParentMax=0;resizeLast=0;collapsible=1;marginBottom=0;whiteSpace=wrap;html=1;" vertex="1" parent="1">
          <mxGeometry x="130" y="1040" width="680" height="200" as="geometry" />
        </mxCell>
        <mxCell id="rM31WVM_aIMixApUrWMA-33" value="+ down_flag:&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;/span&gt;std::atomic&amp;lt;bool&amp;gt;&lt;div&gt;+&amp;nbsp;rwlock:&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;/span&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;RWLock&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;+&amp;nbsp;&lt;/span&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;modified_buckets:&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;/span&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;map&amp;lt;rgw_bucket, rgw_user&amp;gt;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;+&amp;nbsp;&lt;/span&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;buckets_sync_thread:&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;/span&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;BucketsSyncThread *&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;/span&gt;// 周期性将 bucket info 改变的相关信息刷给相关 user&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;+&amp;nbsp;&lt;/span&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;user_sync_thread:&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;/span&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;UserSyncThread *&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;// 周期性&lt;/span&gt;更新 所有 user 的 stats，但是更新不是使用 cache，而是 实时 get user 相关 bucket 的 stats，设置会 user stats 对象&lt;/span&gt;&lt;/div&gt;" style="text;strokeColor=none;fillColor=none;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;whiteSpace=wrap;html=1;" vertex="1" parent="rM31WVM_aIMixApUrWMA-32">
          <mxGeometry y="26" width="680" height="104" as="geometry" />
        </mxCell>
        <mxCell id="rM31WVM_aIMixApUrWMA-34" value="" style="line;strokeWidth=1;fillColor=none;align=left;verticalAlign=middle;spacingTop=-1;spacingLeft=3;spacingRight=3;rotatable=0;labelPosition=right;points=[];portConstraint=eastwest;strokeColor=inherit;" vertex="1" parent="rM31WVM_aIMixApUrWMA-32">
          <mxGeometry y="130" width="680" height="8" as="geometry" />
        </mxCell>
        <mxCell id="rM31WVM_aIMixApUrWMA-35" value="+ fetch_stats_from_storage(type): int override&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;// 同步 get user 的 stats&lt;div&gt;+&amp;nbsp;&lt;span style=&quot;background-color: initial;&quot;&gt;allocate_refresh_handler:&amp;nbsp;AsyncRefreshHandler *&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;//&amp;nbsp;&lt;/span&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;new UserAsyncRefreshHandler(store, this, user, bucket);&lt;/span&gt;&lt;/div&gt;" style="text;strokeColor=none;fillColor=none;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;whiteSpace=wrap;html=1;" vertex="1" parent="rM31WVM_aIMixApUrWMA-32">
          <mxGeometry y="138" width="680" height="62" as="geometry" />
        </mxCell>
      </root>
    </mxGraphModel>
  </diagram>
</mxfile>
